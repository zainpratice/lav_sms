name: Laravel CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'

      - name: Initialize and update git submodules
        run: git submodule update --init --recursive || echo "No submodules to update"

      - name: Install dependencies
        run: |
          # Clean npm cache to avoid any stale cache issues
          npm cache clean --force
          
          # Install PHP dependencies
          composer install --no-interaction --prefer-dist --optimize-autoloader

          # Install Node.js dependencies
          npm install

      - name: Fix file permissions and create .env
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          sudo chmod -R 775 storage bootstrap/cache
          sudo chown -R $USER:$USER storage bootstrap/cache
          sudo chmod 664 .env

      - name: Run tests
        run: |
          # Run PHPUnit tests
          ./vendor/bin/phpunit

      - name: Build production assets
        run: npm run prod

      - name: Deploy application
        run: |
          # Add deployment steps here (e.g., SSH to your server and deploy)
          echo "Deployment steps go here."
          
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Deploy to production server
        run: |
          # Example SSH deploy command
          echo "Deploying to production server"
          ssh user@your-server-ip 'cd /path/to/your/app && git pull && php artisan migrate && npm install && npm run prod'
